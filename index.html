<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Aero Master Chatbot</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />
</head>
<body>
  <div class="app" role="application" aria-label="Aerospace expert chat">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true">
          <!-- simple rocket icon -->
          <svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M12 2c1.5 0 3 1.1 3.3 2.6.3 1.4.2 3.6-.1 5.2-.5 2.7-3 5.1-5.8 5.7C8.4 15.8 6 16 5.1 15.1 4.1 14.1 4.3 11.6 6 9.3 7.6 7.2 10.1 2 12 2z" fill="#fff" opacity="0.95"/>
          </svg>
        </div>
        <div>
          <h1>Aero Master Chatbot</h1>
          <p class="sub">Specialist in aerospace engineering, deep space missions, and observational astronomy</p>
        </div>
      </div>
    </header>

    <div class="bar">
      <div class="mode" role="region" aria-label="response mode">
        <label for="mode">Persona</label>
        <select id="mode" name="mode" title="Choose assistant persona">
          <option value="default" selected>Default Expert</option>
          <option value="engineer">Aerospace Engineer</option>
          <option value="mission">Mission Control</option>
          <option value="astronomer">Observational Astronomer</option>
        </select>
      </div>

      <div class="mode" role="region" aria-label="topic">
        <label for="topic">Topic</label>
        <select id="topic" name="topic" title="Topic focus">
          <option value="general" selected>General Aerospace</option>
          <option value="aircraft">Aircraft Systems</option>
          <option value="propulsion">Propulsion</option>
          <option value="spacecraft">Spacecraft Design</option>
          <option value="deep-space">Deep Space Missions</option>
          <option value="astronomy">Astronomy</option>
        </select>
      </div>
    </div>

    <main id="chat" aria-live="polite"></main>

    <form id="composer" aria-label="Send a message">
      <label for="message" class="visually-hidden">Message</label>
      <input id="message" type="text" placeholder="Ask about rocket stages, orbital mechanics, telescope design..." autocomplete="off" required />
      <button type="submit" id="send">Send</button>
    </form>

    <p class="info">Tip: choose a persona for the style you prefer. Example query: "Explain Hohmann transfer with equations and an example."</p>
  </div>

  <script>
    const chat = document.getElementById('chat');
    const form = document.getElementById('composer');
    const input = document.getElementById('message');
    const modeSel = document.getElementById('mode');
    const topicSel = document.getElementById('topic');

    const history = []; // local context

    function addMsg(role, text) {
      const wrap = document.createElement('div');
      wrap.className = 'msg ' + role;
      const bubble = document.createElement('div');
      bubble.className = 'bubble';
      bubble.innerHTML = (text ?? '').toString().replace(/\n/g, '<br>');
      wrap.appendChild(bubble);
      chat.appendChild(wrap);
      chat.scrollTop = chat.scrollHeight;
      return wrap;
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const text = input.value.trim();
      if (!text) return;
      input.value = '';
      addMsg('user', text);
      history.push({ role: 'user', text });
      const pending = addMsg('model pending', 'Searching star charts and propulsion equations...');
      try {
        const res = await fetch('/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            message: text,
            history,
            mode: modeSel.value,
            topic: topicSel.value
          })
        });
        const data = await res.json();
        pending.classList.remove('pending');
        const bubble = pending.querySelector('.bubble');
        if (data.error) {
          bubble.textContent = 'Error: ' + data.error;
          return;
        }
        const reply = data.reply || '(No response)';
        bubble.innerHTML = reply.replace(/\n/g, '<br>');
        history.push({ role: 'model', text: reply });
        chat.scrollTop = chat.scrollHeight;
      } catch (err) {
        pending.classList.remove('pending');
        const bubble = pending.querySelector('.bubble');
        bubble.textContent = 'Network error: ' + err;
      }
    });
  </script>

  <style>
    .visually-hidden {
      position: absolute !important;
      height: 1px; width: 1px;
      overflow: hidden; clip: rect(1px, 1px, 1px, 1px);
      white-space: nowrap; clip-path: inset(50%);
      border: 0; padding: 0; margin: -1px;
    }
  </style>
</body>
</html>